---
title: "HS project"
subtitle: "Trajectory from HFSCs using slinghshot"
author: "Audrey"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    code_folding: show
    code_download: true
    toc: true
    toc_float: true
    number_sections: false
---


<style>
body {
text-align: justify}
</style>

<!-- Automatically computes and prints in the output the running time for any code chunk -->
```{r, echo=FALSE}
# https://github.com/rstudio/rmarkdown/issues/1453
hooks = knitr::knit_hooks$get()
hook_foldable = function(type) {
  force(type)
  function(x, options) {
    res = hooks[[type]](x, options)
    
    if (isFALSE(options[[paste0("fold_", type)]])) return(res)
    
    paste0(
      "<details><summary>", "show", "</summary>\n\n",
      res,
      "\n\n</details>"
    )
  }
}
knitr::knit_hooks$set(
  output = hook_foldable("output"),
  plot = hook_foldable("plot"),
  time_it = local({
    now = NULL
    function(before, options) {
      if (options$time_it) {
        if (before) {
          now <<- Sys.time()
        } else {
          res = difftime(Sys.time(), now, units = "secs")
          paste("(Time to run :", round(res, digits = 2), "s)")
        }
      }
    }
  })
)
```

<!-- Set default parameters for all chunks -->
```{r, setup, include = FALSE}
set.seed(1337L)
knitr::opts_chunk$set(echo = TRUE, # display code
                      # display chunk output
                      message = FALSE,
                      warning = FALSE,
                      fold_output = FALSE, # usefull for sessionInfo()
                      fold_plot = FALSE,
                      
                      # figure settings
                      fig.align = 'center',
                      fig.width = 20,
                      fig.height = 15,
                      
                      # something about seed, chunk and Rmarkdown compilation
                      # https://stackoverflow.com/questions/39417003/long-vectors-not-supported-yet-error-in-rmd-but-not-in-r-script
                      # cache = TRUE,
                      cache.lazy = FALSE, 
                      
                      # add runtime after chunk
                      time_it = FALSE)
```

This script is used to infer trajectory from HFSCs, using slingshot

```{r library}
library(dplyr)
library(patchwork)
library(ggplot2)

.libPaths()
```


# Preparation

In this section, we set the global settings of the analysis. We will store data there :

```{r out_dir}
save_name = "hfsc_iblmors"
out_dir = "."
```

We load the sample information :

```{r custom_palette_sample, fig.width = 6, fig.height = 6}
sample_info = readRDS(paste0(out_dir, "/../../1_metadata/hs_hd_sample_info.rds"))
project_names_oi = sample_info$project_name

graphics::pie(rep(1, nrow(sample_info)),
              col = sample_info$color,
              labels = sample_info$project_name)
```

This are the settings for trajectory inference :

```{r traj_settings}
traj_dimred = "harmony"      # to infer trajectory on
traj_umap = "harmony_dm"     # just of visualization
seed = 1337L
traj_max_dims = 40           # to infer trajectory on
```

We load the Seurat object :

```{r load_sobj}
sobj = readRDS(paste0(out_dir, "/", save_name, "_sobj.rds"))
sobj
```

# Set root

We visualize clusters and sample of origin :

```{r dimplot, fig.width = 12, fig.height = 5}
sample_of_origin = Seurat::DimPlot(sobj,
                                   group.by = "project_name",
                                   reduction = traj_umap) +
  ggplot2::scale_color_manual(values = sample_info$color,
                              breaks = sample_info$sample_identifiant) +
  ggplot2::labs(title = "Sample of origin") +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5)) +
  Seurat::NoAxes()

clusters = Seurat::DimPlot(sobj, group.by = "seurat_clusters",
                           label = TRUE, reduction = traj_umap) +
  ggplot2::labs(title = "Clusters") +
  Seurat::NoLegend() + Seurat::NoAxes() +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5, face = "bold"))

sample_of_origin | clusters
```

We set the root in the cluster expressing highest level of EPCAM gene.

```{r EPCAM_avg}
root_cluster = data.frame(EPCAM_level = Seurat::FetchData(sobj, vars = "EPCAM", slot = "data")[, 1],
                          clusters = sobj$seurat_clusters) %>%
  dplyr::group_by(clusters) %>%
  dplyr::summarise(EPCAM_avg = mean(EPCAM_level)) %>%
  dplyr::filter(EPCAM_avg == max(EPCAM_avg)) %>%
  dplyr::pull(clusters) %>%
  as.character()

nb_clusters = length(levels(sobj$seurat_clusters))
root_color = aquarius::gg_color_hue(n = nb_clusters)[as.numeric(root_cluster)]
cluster_colors = setNames(nm = levels(sobj$seurat_clusters),
                          rep("gray80", nb_clusters))
cluster_colors[root_cluster] = "red"

root_cluster
```

We visualize root cluster and EPCAM expression levels :

```{r see_root, fig.width = 12, fig.height = 5}
gene_expr = Seurat::FeaturePlot(sobj, features = "EPCAM", reduction = traj_umap) +
  ggplot2::scale_color_gradientn(colors  = aquarius::color_gene) +
  ggplot2::lims(x = range(sobj@reductions[[traj_umap]]@cell.embeddings[, 1]),
                y = range(sobj@reductions[[traj_umap]]@cell.embeddings[, 2])) +
  ggplot2::theme(aspect.ratio = 1) +
  Seurat::NoAxes()

root_plot = clusters = Seurat::DimPlot(sobj, group.by = "seurat_clusters",
                                       cols = cluster_colors,
                                       label = TRUE, reduction = traj_umap) +
  ggplot2::labs(title = "Root cluster") +
  Seurat::NoLegend() + Seurat::NoAxes() +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5, face = "bold"))

gene_expr | root_plot
```

# Trajectory inference

We perform the trajectory inference :

```{r slingshot, cache = FALSE, time_it = TRUE}
input_data = sobj@reductions[[traj_dimred]]@cell.embeddings[, c(1:traj_max_dims)]

my_traj = slingshot::slingshot(data = input_data,
                               clusterLabels = sobj$seurat_clusters,
                               start.clus = root_cluster)
my_traj

## Add pseudotime
all_pdt = slingshot::slingPseudotime(my_traj)
sobj$pseudotime = all_pdt[, 1][colnames(sobj)]
```

# Visualization

We visualize all pseudotimes :

```{r see_pdts, fig.width = 12, fig.height = 10}
plot_list = lapply(c(1:ncol(all_pdt)), FUN = function(lineage) {
  sobj$pseudotime = all_pdt[, lineage][colnames(sobj)]
  
  p = Seurat::FeaturePlot(sobj, features = "pseudotime",
                    reduction = traj_umap,
                    cols = viridis::viridis(n = 100)) +
  ggplot2::lims(x = range(sobj@reductions[[traj_umap]]@cell.embeddings[, 1]),
                y = range(sobj@reductions[[traj_umap]]@cell.embeddings[, 2])) +
  ggplot2::ggtitle(paste0("Pseudotime ", lineage)) +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5)) +
  Seurat::NoAxes()
  
  return(p)
})

patchwork::wrap_plots(plot_list)
```

We add all pseudotimes in the Seurat object :

```{r add_pdt}
for (i in c(1:ncol(all_pdt))) {
  sobj@meta.data[, paste0("pseudotime_", i)] = all_pdt[, paste0("curve", i)][colnames(sobj)]
}

head(sobj@meta.data)
```


# Save

We save the Seurat object :

```{r save_sobj}
saveRDS(sobj, file = paste0(out_dir, "/", save_name, "_sobj_traj_slingshot.rds"))
```

We save the trajectory object :

```{r save_my_traj}
saveRDS(my_traj, file = paste0(out_dir, "/", save_name, "_my_traj_slingshot.rds"))
```


# R Session

```{r sessioninfo, echo = FALSE, fold_output = TRUE}
sessionInfo()
```

