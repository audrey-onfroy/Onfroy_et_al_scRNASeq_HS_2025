---
title: "OEP002321 dataset"
subtitle: "Make ORS + IFE basal dataset"
author: "Audrey"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    code_folding: show
    code_download: true
    toc: true
    toc_float: true
    number_sections: false
---

<style>
body {
text-align: justify}
</style>

<!-- Automatically computes and prints in the output the running time for any code chunk -->
```{r, echo=FALSE}
# https://github.com/rstudio/rmarkdown/issues/1453
hooks = knitr::knit_hooks$get()
hook_foldable = function(type) {
  force(type)
  function(x, options) {
    res = hooks[[type]](x, options)
    
    if (isFALSE(options[[paste0("fold_", type)]])) return(res)
    
    paste0(
      "<details><summary>", "show", "</summary>\n\n",
      res,
      "\n\n</details>"
    )
  }
}
knitr::knit_hooks$set(
  output = hook_foldable("output"),
  plot = hook_foldable("plot"),
  time_it = local({
    now = NULL
    function(before, options) {
      if (options$time_it) {
        if (before) {
          now <= Sys.time()
        } else {
          res = difftime(Sys.time(), now, units = "secs")
          paste("(Time to run :", round(res, digits = 2), "s)")
        }
      }
    }
  })
)
```

<!-- Set default parameters for all chunks -->
```{r, setup, include = FALSE}
set.seed(1337L)
knitr::opts_chunk$set(echo = TRUE, # display code
                      # display chunk output
                      message = FALSE,
                      warning = FALSE,
                      fold_output = FALSE, # usefull for sessionInfo()
                      fold_plot = FALSE,
                      
                      # figure settings
                      fig.align = 'center',
                      fig.width = 20,
                      fig.height = 15,
                      
                      # something about seed, chunk and Rmarkdown compilation
                      # https://stackoverflow.com/questions/39417003/long-vectors-not-supported-yet-error-in-rmd-but-not-in-r-script
                      # cache = TRUE,
                      cache.lazy = FALSE, 
                      
                      # add runtime after chunk
                      time_it = FALSE)
```


This file is used to generate a dataset containing only ORS and IFE basal cells.

```{r library}
library(dplyr)
library(patchwork)
library(ggplot2)

.libPaths()
```


# Preparation

In this section, we set the global settings of the analysis. We will store data there :

```{r out_dir}
save_name = "ors_ifeb"
out_dir = "."
```

We load the sample information :

```{r custom_palette_sample, fig.width = 6, fig.height = 6}
sample_info = readRDS(paste0(out_dir, "/../1_metadata/wu_sample_info.rds"))
project_names_oi = sample_info$project_name

graphics::pie(rep(1, nrow(sample_info)),
              col = sample_info$color,
              labels = sample_info$project_name)
```

Here are custom colors for each cell type :

```{r color_markers, fig.width = 10, fig.height = 1.2, class.source = "fold-hide"}
color_markers = readRDS(paste0(out_dir, "/../../1_metadata/hs_hd_color_markers.rds"))

data.frame(cell_type = names(color_markers),
           color = unlist(color_markers)) %>%
  ggplot2::ggplot(., aes(x = cell_type, y = 0, fill = cell_type)) +
  ggplot2::geom_point(pch = 21, size = 5) +
  ggplot2::scale_fill_manual(values = unlist(color_markers), breaks = names(color_markers)) +
  ggplot2::theme_classic() +
  ggplot2::theme(legend.position = "none",
                 axis.line = element_blank(),
                 axis.title = element_blank(),
                 axis.ticks = element_blank(),
                 axis.text.y = element_blank(),
                 axis.text.x = element_text(angle = 30, hjust = 1))
```

# Make `r save_name` dataset

## Atlas

We load the combined dataset containing all cell types from all samples :

```{r load_atlas}
sobj = readRDS(paste0(out_dir, "/../3_combined/wu_sobj.rds"))
sobj
```

We represent cells in the tSNE :

```{r name2D}
name2D = "harmony_38_tsne"
```

We smooth cell type annotation at a cluster level :

```{r smooth_annotation}
cluster_type = table(sobj$cell_type, sobj$seurat_clusters) %>%
  prop.table(., margin = 2) %>%
  apply(., 2, which.max)
cluster_type = setNames(nm = names(cluster_type),
                        levels(sobj$cell_type)[cluster_type])

sobj$cluster_type = cluster_type[sobj$seurat_clusters]
```


We look gene markers expression level, cell annotation and cluster-smoothed annotation on the projection, to locate `r save_name` cells :

```{r see_iblmors_markers, fig.width = 12, fig.height = 3}
iblmors_markers = c("KRT16", "EHF", "ALDH3A1")
iblmors_cell_type = c("ORS", "IFE basal")
color_markers[!(names(color_markers) %in% iblmors_cell_type)] = "gray92"

# Feature Plot
plot_list = lapply(iblmors_markers, FUN = function(one_gene) {
  p = Seurat::FeaturePlot(sobj, reduction = name2D,
                          features = one_gene) +
    Seurat::NoAxes() +
    ggplot2::scale_color_gradientn(colors = aquarius:::color_gene) +
    ggplot2::theme(aspect.ratio = 1,
                   plot.subtitle = element_text(hjust = 0.5))
  return(p)
})

# Cell type annotation
plot_list[[length(plot_list) + 1]] = Seurat::DimPlot(sobj, group.by = "cell_type",
                                                     cols = color_markers, reduction = name2D,
                                                     order = save_name) +
  ggplot2::labs(title = "Cell annotation",
                subtitle = paste0(sum(sobj$cell_type %in% iblmors_cell_type),
                                  " cells")) +
  Seurat::NoAxes() + Seurat::NoLegend() +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5),
                 plot.subtitle = element_text(hjust = 0.5))

# Cluster-smoothed annotation
plot_list[[length(plot_list) + 1]] = Seurat::DimPlot(sobj,
                                                     reduction = name2D,
                                                     group.by = "cluster_type") +
  ggplot2::scale_color_manual(values = c(unname(unlist(color_markers[iblmors_cell_type])),
                                         rep("gray92", length(color_markers) - length(iblmors_cell_type))),
                              breaks = c(iblmors_cell_type, setdiff(names(color_markers), iblmors_cell_type))) +
  ggplot2::labs(title = "Cluster annotation",
                subtitle = paste0(sum(sobj$cluster_type %in% iblmors_cell_type),
                                  " cells")) +
  Seurat::NoAxes() + Seurat::NoLegend() +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5),
                 plot.subtitle = element_text(hjust = 0.5))

patchwork::wrap_plots(plot_list, nrow = 1)
```

Due to clustering that badly separate ORS from IFE, there is a mis-selection of cells of interest : false positive. However, annotation smoothing adds a lot of (all) false negative and clean the annotation. We extract cells of interest based on clustering. Then, we generate a new cluster to remove false positive.

## Combined dataset

We extract cells of interest based on the clustering :

```{r subset_is_of_interest}
sobj = subset(sobj, cluster_type %in% iblmors_cell_type)
sobj
```

We remove all things that were calculated based on the full atlas :

```{r remove_reductions}
sobj = Seurat::DietSeurat(sobj)
sobj
```

## Clean metadata

We keep a subset of meta.data and reset levels :

```{r sobj_set_factor_levels}
sobj@meta.data = sobj@meta.data[, c("orig.ident", "nCount_RNA", "nFeature_RNA", "log_nCount_RNA",
                                    "project_name", "sample_identifier", "sample_type",
                                    "laboratory", "location", "Seurat.Phase", "cyclone.Phase",
                                    "percent.mt", "percent.rb", "cell_type")]

sobj$orig.ident = factor(sobj$orig.ident, levels = levels(sample_info$project_name))
sobj$project_name = factor(sobj$project_name, levels = levels(sample_info$project_name))
sobj$sample_identifier = factor(sobj$sample_identifier, levels = levels(sample_info$sample_identifier))
sobj$sample_type = factor(sobj$sample_type, levels = levels(sample_info$sample_type))

summary(sobj@meta.data)
```


# Processing

## Metadata

How many cells by sample ?

```{r table_orig_ident}
table(sobj$project_name)
```

We represent this information as a barplot :

```{r barplot_count, fig.width = 8, fig.height = 5}
aquarius::plot_barplot(df = table(sobj$project_name,
                                  sobj$cell_type) %>%
                         as.data.frame.table() %>%
                         `colnames<-`(c("project_name", "cell_type", "nb_cells")),
                       x = "project_name", y = "nb_cells", fill = "cell_type",
                       position = position_stack()) +
  ggplot2::scale_fill_manual(values = color_markers,
                             breaks = names(color_markers),
                             name = "Cell type")
```

## Remove false positive

We normalize gene expression for remaining cells :

```{r normalization}
sobj = Seurat::NormalizeData(sobj,
                             normalization.method = "LogNormalize")
sobj = Seurat::FindVariableFeatures(sobj, nfeatures = 3000)
sobj = Seurat::ScaleData(sobj)

sobj
```

We perform a PCA :

```{r pca}
sobj = Seurat::RunPCA(sobj,
                      assay = "RNA",
                      reduction.name = "RNA_pca",
                      npcs = 100,
                      seed.use = 1337L)
sobj
```

We choose the number of dimensions such that they summarize 60 % of the variability :

```{r ndims}
stdev = sobj@reductions[["RNA_pca"]]@stdev
stdev_prop = cumsum(stdev)/sum(stdev)
ndims = which(stdev_prop > 0.60)[1]
ndims
```

We can visualize this on the elbow plot :

```{r elbowplot, fig.width = 12, fig.height = 4}
elbow_p = Seurat::ElbowPlot(sobj, ndims = 100, reduction = "RNA_pca") +
  ggplot2::geom_point(x = ndims, y = stdev[ndims], col = "red")
x_text = ggplot_build(elbow_p)$layout$panel_params[[1]]$x$get_labels() %>% as.numeric()
elbow_p = elbow_p +
  ggplot2::scale_x_continuous(breaks = sort(c(x_text, ndims)), limits = c(0, 100))
x_color = ifelse(ggplot_build(elbow_p)$layout$panel_params[[1]]$x$get_labels() %>%
                   as.numeric() %>% round(., 2) == round(ndims, 2), "red", "black")
elbow_p = elbow_p +
  ggplot2::theme_classic() +
  ggplot2::theme(axis.text.x = element_text(color = x_color))

elbow_p
```

We generate a tSNE and a UMAP with `r ndims` principal components :

```{r tsne_umap}
sobj = Seurat::RunTSNE(sobj,
                       reduction = "RNA_pca",
                       dims = 1:ndims,
                       seed.use = 1337L,
                       reduction.name = paste0("RNA_pca_", ndims, "_tsne"))

sobj = Seurat::RunUMAP(sobj,
                       reduction = "RNA_pca",
                       dims = 1:ndims,
                       seed.use = 1337L,
                       reduction.name = paste0("RNA_pca_", ndims, "_umap"))
```

We can visualize the two representations :

```{r see_umap_tsne, fig.width = 8, fig.height = 4, class.source = "fold-hide"}
tsne = Seurat::DimPlot(sobj, group.by = "project_name",
                       reduction = paste0("RNA_pca_", ndims, "_tsne")) +
  ggplot2::scale_color_manual(values = sample_info$color,
                              breaks = sample_info$project_name) +
  Seurat::NoAxes() + ggplot2::ggtitle("PCA - tSNE") +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5),
                 legend.position = "none")

umap = Seurat::DimPlot(sobj, group.by = "project_name",
                       reduction = paste0("RNA_pca_", ndims, "_umap")) +
  ggplot2::scale_color_manual(values = sample_info$color,
                              breaks = sample_info$project_name) +
  Seurat::NoAxes() + ggplot2::ggtitle("PCA - UMAP") +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5))

tsne | umap
```


We generate a clustering from the PCA :

```{r clustering, fig.width = 6, fig.height = 5}
reduction_name = "RNA_pca"

sobj = Seurat::FindNeighbors(sobj, reduction = reduction_name)
sobj = Seurat::FindClusters(sobj, resolution = 1.7)

cluster_plot = Seurat::DimPlot(sobj, label = TRUE,
                               reduction = paste0(reduction_name, "_", ndims, "_umap")) +
  Seurat::NoAxes() +
  ggplot2::theme(aspect.ratio = 1)
cluster_plot
```

We look at key markers for `r save_name` cells, and for eventual contamination :

```{r plot_genes, fig.width = 12, fig.height = 6}
plot_list = lapply(c("nFeature_RNA", iblmors_markers,
                     c("SPINK5", "KRT1", "KRT31", "PRR9")), FUN = function(one_gene) {
                       Seurat::FeaturePlot(sobj, features = one_gene,
                                           reduction = paste0(reduction_name, "_", ndims, "_umap")) +
                         ggplot2::scale_color_gradientn(colors = aquarius::color_gene) +
                         ggplot2::theme(aspect.ratio = 1) +
                         Seurat::NoAxes() + Seurat::NoLegend()
                     })

patchwork::wrap_plots(plot_list, nrow = 2)
```

We select clusters based on PRR9 (cortex) expression :

```{r select_clusters, fig.width = 10, fig.height = 5}
mean_score_thresh = 1.3

sobj$PRR9_expr = Seurat::FetchData(sobj, "PRR9")
score_by_clusters = sobj@meta.data %>%
  dplyr::select(seurat_clusters, PRR9_expr) %>%
  dplyr::group_by(seurat_clusters) %>%
  dplyr::summarise(avg_score = mean(PRR9_expr)) %>%
  as.data.frame()

ggplot2::ggplot(score_by_clusters, aes(x = seurat_clusters, y = avg_score)) +
  ggplot2::geom_point() +
  ggplot2::geom_hline(yintercept = mean_score_thresh, col = "red") +
  ggplot2::labs(x = "Cluster ID", y = "Mean PRR9 expression",
                title = "Proportion of cells by cluster") +
  ggplot2::theme_classic() +
  ggplot2::theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

We remove clusters above threshold :

```{r clusters_removal}
clusters_to_remove = score_by_clusters %>%
  dplyr::filter(avg_score > mean_score_thresh) %>%
  dplyr::pull(seurat_clusters) %>%
  as.character()

sobj = subset(sobj, idents = clusters_to_remove, invert = TRUE)
sobj
```

We remove all reductions in this dataset :

```{r diet_sobj}
sobj = Seurat::DietSeurat(sobj, assays = "RNA")
sobj
```

How many cells by sample ?

```{r table_orig_ident2}
table(sobj$project_name)
```

We represent this information as a barplot :

```{r barplot_count2, fig.width = 8, fig.height = 5}
aquarius::plot_barplot(df = table(sobj$project_name,
                                  sobj$cell_type) %>%
                         as.data.frame.table() %>%
                         `colnames<-`(c("project_name", "cell_type", "nb_cells")),
                       x = "project_name", y = "nb_cells", fill = "cell_type",
                       position = position_fill()) +
  ggplot2::scale_fill_manual(values = color_markers,
                             breaks = names(color_markers),
                             name = "Cell type")
```

No contamination remaining !

## Projection

We remove genes that are expressed in less than 5 cells :

```{r filter_genes}
sobj = aquarius::filter_features(sobj, min_cells = 5)
sobj
```


We normalize the count matrix for remaining cells :

```{r normalization2}
sobj = Seurat::NormalizeData(sobj,
                             normalization.method = "LogNormalize")
sobj = Seurat::FindVariableFeatures(sobj, nfeatures = 2000)
sobj = Seurat::ScaleData(sobj)

sobj
```

We perform a PCA :

```{r pca2}
sobj = Seurat::RunPCA(sobj,
                      assay = "RNA",
                      reduction.name = "RNA_pca",
                      npcs = 100,
                      seed.use = 1337L)
sobj
```

We choose the number of dimensions such that they summarize 35 % of the variability :

```{r ndims2}
stdev = sobj@reductions[["RNA_pca"]]@stdev
stdev_prop = cumsum(stdev)/sum(stdev)
ndims = which(stdev_prop > 0.35)[1]
ndims
```

We can visualize this on the elbow plot :

```{r elbowplot2, fig.width = 12, fig.height = 4}
elbow_p = Seurat::ElbowPlot(sobj, ndims = 100, reduction = "RNA_pca") +
  ggplot2::geom_point(x = ndims, y = stdev[ndims], col = "red")
x_text = ggplot_build(elbow_p)$layout$panel_params[[1]]$x$get_labels() %>% as.numeric()
elbow_p = elbow_p +
  ggplot2::scale_x_continuous(breaks = sort(c(x_text, ndims)), limits = c(0, 100))
x_color = ifelse(ggplot_build(elbow_p)$layout$panel_params[[1]]$x$get_labels() %>%
                   as.numeric() %>% round(., 2) == round(ndims, 2), "red", "black")
elbow_p = elbow_p +
  ggplot2::theme_classic() +
  ggplot2::theme(axis.text.x = element_text(color = x_color))

elbow_p
```

### Without correction

We generate a tSNE and a UMAP with `r ndims` principal components :

```{r tsne_umap2}
sobj = Seurat::RunTSNE(sobj,
                       reduction = "RNA_pca",
                       dims = 1:ndims,
                       seed.use = 1337L,
                       reduction.name = paste0("RNA_pca_", ndims, "_tsne"))

sobj = Seurat::RunUMAP(sobj,
                       reduction = "RNA_pca",
                       dims = 1:ndims,
                       seed.use = 1337L,
                       reduction.name = paste0("RNA_pca_", ndims, "_umap"))
```

We can visualize the two representations :

```{r see_umap_tsne2, fig.width = 8, fig.height = 4, class.source = "fold-hide"}
tsne = Seurat::DimPlot(sobj, group.by = "project_name",
                       reduction = paste0("RNA_pca_", ndims, "_tsne")) +
  ggplot2::scale_color_manual(values = sample_info$color,
                              breaks = sample_info$project_name) +
  Seurat::NoAxes() + ggplot2::ggtitle("PCA - tSNE") +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5),
                 legend.position = "none")

umap = Seurat::DimPlot(sobj, group.by = "project_name",
                       reduction = paste0("RNA_pca_", ndims, "_umap")) +
  ggplot2::scale_color_manual(values = sample_info$color,
                              breaks = sample_info$project_name) +
  Seurat::NoAxes() + ggplot2::ggtitle("PCA - UMAP") +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5))

tsne | umap
```

There is a batch-effect mainly in the right population : due to the disease ?

### Harmony

We remove batch-effect using Harmony :

```{r harmony, fig.width = 8, fig.height = 5}
`%||%` = function(lhs, rhs) {
  if (!is.null(x = lhs)) {
    return(lhs)
  } else {
    return(rhs)
  }
}

set.seed(1337L)
sobj = harmony::RunHarmony(object = sobj,
                           group.by.vars = "project_name",
                           plot_convergence = TRUE,
                           reduction = "RNA_pca",
                           assay.use = "RNA",
                           reduction.save = "harmony",
                           max.iter.harmony = 20,
                           project.dim = FALSE)
```

From this batch-effect removed projection, we generate a tSNE and a UMAP.

```{r harmony_tsne_umap, fig.width = 12, fig.height = 12}
sobj = Seurat::RunUMAP(sobj, 
                       seed.use = 1337L,
                       dims = 1:ndims,
                       reduction = "harmony",
                       reduction.name = paste0("harmony_", ndims, "_umap"),
                       reduction.key = paste0("harmony_", ndims, "umap_"))
sobj = Seurat::RunTSNE(sobj,
                       dims = 1:ndims,
                       seed.use = 1337L,
                       reduction = "harmony",
                       reduction.name = paste0("harmony_", ndims, "_tsne"),
                       reduction.key = paste0("harmony", ndims, "tsne_"))
```

These are the corrected UMAP and tSNE :

```{r see_umap_tsne_harmony1, fig.width = 8, fig.height = 4, class.source = "fold-hide"}
tsne = Seurat::DimPlot(sobj, group.by = "project_name",
                       reduction = paste0("harmony_", ndims, "_tsne")) +
  ggplot2::scale_color_manual(values = sample_info$color,
                              breaks = sample_info$project_name) +
  Seurat::NoAxes() + ggplot2::ggtitle("PCA - harmony - tSNE") +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5),
                 legend.position = "none")

umap = Seurat::DimPlot(sobj, group.by = "project_name",
                       reduction = paste0("harmony_", ndims, "_umap")) +
  ggplot2::scale_color_manual(values = sample_info$color,
                              breaks = sample_info$project_name) +
  Seurat::NoAxes() + ggplot2::ggtitle("PCA - harmony - UMAP") +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = element_text(hjust = 0.5))

tsne | umap
```


We will keep the tSNE from Harmony :

```{r set_name2D}
reduction = "harmony"
name2D = paste0("harmony_", ndims, "_tsne")
```

## Clustering

We generate a clustering :

```{r clustering2, fig.width = 6, fig.height = 4}
sobj = Seurat::FindNeighbors(sobj, reduction = reduction, dims = 1:ndims)
sobj = Seurat::FindClusters(sobj, resolution = 1)

dimplot_clusters = Seurat::DimPlot(sobj, reduction = name2D, label = TRUE) +
  Seurat::NoAxes() +
  ggplot2::theme(aspect.ratio = 1)
dimplot_clusters
```


# Visualization

We can represent the 4 quality metrics :

```{r qc_plot, fig.width = 12, fig.height = 3}
plot_list = Seurat::FeaturePlot(sobj, reduction = name2D,
                                combine = FALSE, pt.size = 0.5,
                                features = c("percent.mt", "percent.rb", "nFeature_RNA", "log_nCount_RNA"))
plot_list = lapply(plot_list, FUN = function(one_plot) {
  one_plot +
    Seurat::NoAxes() +
    ggplot2::scale_color_gradientn(colors = aquarius:::color_gene) +
    ggplot2::theme(aspect.ratio = 1)
})

patchwork::wrap_plots(plot_list, nrow = 1)
```

## Project name

We can visualize the two batch-effect corrected representations :

```{r see_umap_tsne_all, fig.width = 8, fig.height = 4, class.source = "fold-hide"}
plot_list = lapply(c(paste0("harmony_", ndims, "_tsne"),
                     paste0("harmony_", ndims, "_umap")), FUN = function(one_proj) {
                       Seurat::DimPlot(sobj, group.by = "project_name",
                                       reduction = one_proj) +
                         ggplot2::scale_color_manual(values = sample_info$color,
                                                     breaks = sample_info$project_name) +
                         Seurat::NoAxes() + ggplot2::ggtitle(one_proj) +
                         ggplot2::theme(aspect.ratio = 1,
                                        plot.title = element_text(hjust = 0.5),
                                        legend.position = "none")
                     })

patchwork::wrap_plots(plot_list, ncol = 2)
```

## Cell type

We also visualize cell types :

```{r see_umap_tsne_celltype, fig.width = 8, fig.height = 4, class.source = "fold-hide"}
plot_list = lapply(c(paste0("harmony_", ndims, "_tsne"),
                     paste0("harmony_", ndims, "_umap")), FUN = function(one_proj) {
                       Seurat::DimPlot(sobj, group.by = "cell_type",
                                       reduction = one_proj) +
                         ggplot2::scale_color_manual(values = color_markers,
                                                     breaks = names(color_markers)) +
                         Seurat::NoAxes() + ggplot2::ggtitle(one_proj) +
                         ggplot2::theme(aspect.ratio = 1,
                                        plot.title = element_text(hjust = 0.5),
                                        legend.position = "none")
                     })

patchwork::wrap_plots(plot_list, ncol = 2)
```

## Clusters

We can represent clusters, split by sample of origin :

```{r plot_split_dimred, fig.width = 12, fig.height = 7}
plot_list = aquarius::plot_split_dimred(sobj,
                                        reduction = name2D,
                                        split_by = "sample_identifier",
                                        group_by = "seurat_clusters",
                                        split_color = setNames(sample_info$color,
                                                               nm = sample_info$sample_identifier),
                                        group_color = aquarius::gg_color_hue(length(levels(sobj$seurat_clusters))),
                                        main_pt_size = 0.5, bg_pt_size = 0.5)

plot_list[[length(plot_list) + 1]] = dimplot_clusters

patchwork::wrap_plots(plot_list, ncol = 4) +
  patchwork::plot_layout(guides = "collect") &
  ggplot2::theme(legend.position = "none")
```

We look at genes of interest on the projection :

```{r plot_genes_oi, fig.width = 12, fig.height = 7}
cluster_markers = c("KRT14",
                    # IFE basal-related
                    "KRT16", "MGP", "KRT6C", "CST6",
                    # IFE basal
                    "GPX2", "C1QTNF12", "PTN", "CLEC2B", "TGFBI",
                    # QC metrics
                    "TOP2A", "MCM5",
                    "percent.mt", "percent.rb", "log_nCount_RNA")

plot_list = lapply(cluster_markers, FUN = function(one_gene) {
  p = Seurat::FeaturePlot(sobj, features = one_gene,
                          pt.size = 0.2, reduction = name2D) +
    ggplot2::scale_color_gradientn(colors = aquarius::color_gene) +
    Seurat::NoAxes() +
    ggplot2::theme(aspect.ratio = 1)
  
  return(p)
})

patchwork::wrap_plots(plot_list, ncol = 5)
```

# Save

We save the Seurat object :

```{r save_sobj}
saveRDS(sobj, file = paste0(out_dir, "/", save_name, "_sobj.rds"))
```


# R Session

```{r sessioninfo, echo = FALSE, fold_output = TRUE}
sessionInfo()
```

